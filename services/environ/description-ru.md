# Environ

## Введение

Сервер написан на Python3.5 и состоит из двух частей:
+   простенького веб дашборда на Flask
+   серверной части, которая обеспечивала общение по протоколу поверх сырого wifi.

Для идентификации команд в сети, куда все имеют доступ, и никто никому не доверяет, используется RSA подпись пакетов (каждый сервис отдает свой публичный ключ по web), а для шифрования траффика в незащищенном эфире используется честный протокол обмена ключами Диффи-Хеллмана, с тем лишь упрощением, что в качестве модуля поля выбиралось простое 64-битное число, в качестве закрытого ключа чекера - простое 32-битное, а в качестве закрытого ключа сервиса - лишь 16-ти битное.

## Уязвимости

### DH
Такое упрощение на стороне чекера не приводит к возможности взлома протокола за разумные сроки, но короткий закрытый ключ сервиса позволяет довольно быстро подобрать его и получить возможность "видеть" все флаги еще в тот момент, когда они устанавливаются.

Для этого есть рабочий эксплойт /ructf-2016/services/environ/tests/sploit.py, который запоминает публичный DH обмен по командам и для каждого увиденного сообщения об установке флага пытается найти секретный ключ и расшифровать сообщение.

### Guid?

При записи флага на диск сервис использует функцию guid(), которая использует всего 6 случайных hex-символов, что позволяет перебрать все варианты, обращаясь по веб на /<some>

### Path traversal

Можно заметить, что в функции show_raw() используется не send_static_file, а нерекомендуемая Flask send_file, которая не защищена от path_traversal. Так как сервис пишет логи только в journald, прочитать их все равно не удалось бы, но зато можно было получить доступ к приватному RSA ключу и в последующем общении с чекером представляться этой командой, со всеми вытекающими: получением флага и mumble на атакуемой команде.

